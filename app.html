<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>子育て住まいチェッカー</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <h2>数字を選んでください（なんかもっとあるかも）</h2>
    <input type="text" placeholder="住所を入力してください" />

    <h3>生活利便性</h3>
    <label><input type="radio" name="useful" value="1" />1</label>
    <label><input type="radio" name="useful" value="2" />2</label>
    <label><input type="radio" name="useful" value="3" />3</label>
    <label><input type="radio" name="useful" value="4" />4</label>
    <label><input type="radio" name="useful" value="5" />5</label>

    <h3>安全性（anzen）</h3>
    <label><input type="radio" name="anzen" value="1" />1</label>
    <label><input type="radio" name="anzen" value="2" />2</label>
    <label><input type="radio" name="anzen" value="3" />3</label>
    <label><input type="radio" name="anzen" value="4" />4</label>
    <label><input type="radio" name="anzen" value="5" />5</label>

    <h3>交通アクセス性（station）</h3>
    <label><input type="radio" name="station" value="1" />1</label>
    <label><input type="radio" name="station" value="2" />2</label>
    <label><input type="radio" name="station" value="3" />3</label>
    <label><input type="radio" name="station" value="4" />4</label>
    <label><input type="radio" name="station" value="5" />5</label>

    <h3>環境快適性</h3>
    <label><input type="radio" name="comfort" value="1" />1</label>
    <label><input type="radio" name="comfort" value="2" />2</label>
    <label><input type="radio" name="comfort" value="3" />3</label>
    <label><input type="radio" name="comfort" value="4" />4</label>
    <label><input type="radio" name="comfort" value="5" />5</label>

    <h3>教育充実度</h3>
    <label><input type="radio" name="service" value="1" />1</label>
    <label><input type="radio" name="service" value="2" />2</label>
    <label><input type="radio" name="service" value="3" />3</label>
    <label><input type="radio" name="service" value="4" />4</label>
    <label><input type="radio" name="service" value="5" />5</label>

    <!-- ここのbrは仮で -->
    <br /><br />
    <button id="submit">決定</button>
  </body>
</html>
<!-- グーグルスタジオUI -->
<script>
  function weightedScore(scores, weights) {
    if (!Array.isArray(scores) || !Array.isArray(weights)) throw new Error("scores/weights must be arrays");
    if (scores.length !== weights.length) throw new Error("scores と weights の長さが一致しません");
    if (scores.length === 0) throw new Error("scores が空です");
    const totalWeight = weights.reduce((a, b) => a + Number(b), 0);
    if (totalWeight <= 0) throw new Error("weights の合計は 0 より大きくしてください");
    const sum = scores.reduce((acc, score, i) => acc + Number(score) * Number(weights[i]), 0);
    return sum / totalWeight;
  }

  document.getElementById("submit").addEventListener("click", async () => {
    const address = document.querySelector('input[type="text"]').value.trim();

    // 住所が "京都" で始まらなければ無効
    const regex = /^京都/;

    if (!regex.test(address) || address.length < 10) {
      alert("京都の正しい住所を入力してください");
      return; // 画面遷移を止める
    }

    // ラジオチェック
    const radioGroups = ["useful", "anzen", "station", "comfort", "service"];
    const data = {}; // Pythonに送るデータ
    for (const groupName of radioGroups) {
      const checked = document.querySelector(
        `input[name="${groupName}"]:checked`,
      );
      if (!checked) {
        alert("全ての項目を選択してください");
        return;
      }
      data[groupName] = checked.value;
    }

    // 住所も送る
    data.address = address;

    try {
      // 住所解析 + 各種スコア（address_submit_server.py -> address1_where.py 等）
      const addrRes = await fetch("http://127.0.0.1:8000/submit-json", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address }),
      });
      if (!addrRes.ok) {
        throw new Error(`address server error: ${addrRes.status}`);
      }
      const addressResult = await addrRes.json();

      // 今ある基準は anzen / station。kajuave.py(/weighted) で集約（失敗時は同式でフォールバック）
      const anzenScore = Number(addressResult.score);
      const stationScore = Number(addressResult.station_score);
      const anzenWeight = Number(data.anzen);
      const stationWeight = Number(data.station);

      let kajuaveResult = null;
      if (!Number.isNaN(anzenScore) && !Number.isNaN(stationScore)) {
        const scores = [anzenScore, stationScore];
        const weights = [anzenWeight, stationWeight];
        let weightedResult = null;

        try {
          const kajuaveRes = await fetch("http://127.0.0.1:5000/weighted", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ scores, weights }),
          });
          if (!kajuaveRes.ok) throw new Error(`kajuave server error: ${kajuaveRes.status}`);
          const kajuaveJson = await kajuaveRes.json();
          weightedResult = Number(kajuaveJson.weighted_result);
        } catch (_kajuaveErr) {
          weightedResult = Number((weightedScore(scores, weights) * 100).toFixed(4));
        }

        kajuaveResult = {
          criteria: ["anzen", "station"],
          scores,
          weights,
          weighted_result: Number(Number(weightedResult).toFixed(4)),
        };
      }

      localStorage.setItem("app_form_input", JSON.stringify(data));
      localStorage.setItem("address_result", JSON.stringify(addressResult));
      localStorage.setItem("kajuave_result", JSON.stringify(kajuaveResult));
      window.location.href = "result.html";
    } catch (err) {
      console.error(err);
      alert("送信に失敗しました。address_submit_server.py が起動しているか確認してください。");
    }
  });
</script>
